[databases]
; Database connection strings
; Format: dbname = host=hostname port=port dbname=database
ndp = host=postgresql port=5432 dbname=ndp auth_user=ndp
ndp_readonly = host=postgresql-replica port=5432 dbname=ndp auth_user=ndp_readonly

[pgbouncer]
; ============================================================================
; PgBouncer Configuration for NDP Backend
; Supports 10,000+ concurrent connections
; ============================================================================

; Listen address and port
listen_addr = 0.0.0.0
listen_port = 6432

; Authentication
auth_type = md5
auth_file = /etc/pgbouncer/userlist.txt

; Pool mode
; transaction: Return connection after transaction (recommended for most cases)
; session: Return connection after client disconnects
; statement: Return connection after each statement
pool_mode = transaction

; Connection pool settings
; Maximum number of client connections allowed
max_client_conn = 10000

; Default pool size per user/database pair
default_pool_size = 100

; Minimum pool size maintained even if not needed
min_pool_size = 10

; How many additional connections to allow per pool
reserve_pool_size = 25

; How long to wait before releasing reserved connections
reserve_pool_timeout = 5

; Maximum number of server connections per database
max_db_connections = 500

; Maximum number of server connections per user
max_user_connections = 200

; ============================================================================
; Timeouts
; ============================================================================

; Close server connection if unused for this many seconds
server_idle_timeout = 600

; Close client connection if it has been waiting for this many seconds
client_idle_timeout = 3600

; Cancel query if client disconnects and query runs longer than this
query_timeout = 120

; Cancel query if it takes longer than this (0 = disable)
query_wait_timeout = 120

; Terminate server connection if it cannot be reused
server_lifetime = 3600

; Time to wait for server connection
server_connect_timeout = 15

; Time to wait for login packet from client
client_login_timeout = 60

; ============================================================================
; Logging
; ============================================================================

; Log file location
logfile = /var/log/pgbouncer/pgbouncer.log

; Log level: debug, info, notice, warning, error, fatal, panic
log_connections = 1
log_disconnections = 1
log_pooler_errors = 1
stats_period = 60

; Syslog settings
syslog = 0
syslog_ident = pgbouncer
syslog_facility = daemon

; ============================================================================
; Admin Settings
; ============================================================================

; Admin database name (for monitoring)
admin_users = pgbouncer_admin

; Allow only this list of users to connect to admin DB
stats_users = pgbouncer_stats

; ============================================================================
; Security
; ============================================================================

; Ignore startup packet that has extra fields
ignore_startup_parameters = extra_float_digits

; TLS settings for server connections
server_tls_sslmode = prefer
server_tls_ca_file = /etc/ssl/certs/ca-certificates.crt

; TLS settings for client connections
client_tls_sslmode = prefer
client_tls_key_file = /etc/pgbouncer/server.key
client_tls_cert_file = /etc/pgbouncer/server.crt

; ============================================================================
; Application Name Tracking
; ============================================================================

; Pass application_name from client to server
application_name_add_host = 1

; ============================================================================
; TCP Settings
; ============================================================================

; Enable TCP keepalive
tcp_keepalive = 1
tcp_keepidle = 30
tcp_keepintvl = 10
tcp_keepcnt = 3

; Enable TCP nodelay
tcp_socket_buffer = 0

; ============================================================================
; DNS Settings
; ============================================================================

; How often to check DNS for host resolution
dns_max_ttl = 300
dns_nxdomain_ttl = 15
